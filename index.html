<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Guide</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #6366f1;
    --secondary: #ec4899;
    --success: #10b981;
    --bg: #f8f9fb;
    --text: #1a202c;
    --border: #e2e8f0;
    --card-bg: #ffffff;
}

[data-color-scheme="dark"] {
    --bg: #0f172a;
    --text: #f1f5f9;
    --border: #334155;
    --card-bg: #1e293b;
}

html {
    transition: background-color 0.3s ease;
    background-color: var(--bg);
    color: var(--text);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    line-height: 1.6;
}

.header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    flex-wrap: wrap;
    gap: 1rem;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.3rem;
    font-weight: bold;
}

.connection-status {
    font-size: 0.85rem;
    opacity: 0.9;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.theme-toggle, .profile-btn, .logout-btn, .admin-btn {
    padding: 0.6rem 1rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.theme-toggle:hover, .profile-btn:hover, .logout-btn:hover, .admin-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.logout-btn, .admin-btn {
    display: none;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.welcome {
    text-align: center;
    padding: 3rem 1rem;
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.welcome.hidden {
    display: none;
}

.welcome h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.welcome p {
    font-size: 1.1rem;
    opacity: 0.7;
    margin-bottom: 2rem;
}

.cta-button {
    padding: 1rem 2rem;
    font-size: 1rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.cta-button:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
}

.form-container {
    display: none;
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.form-container.active {
    display: block;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-bottom: 2rem;
    overflow: hidden;
}

#progressFill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    width: 0%;
    transition: width 0.3s;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-group input[type="text"],
.form-group input[type="date"],
.form-group input[type="email"],
.form-group input[type="password"],
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 1rem;
    background: var(--bg);
    color: var(--text);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkbox-item input {
    width: auto;
}

.form-buttons {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text);
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
}

.btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-color: transparent;
}

.btn-primary:hover {
    opacity: 0.9;
}

.results {
    display: none;
    animation: fadeIn 0.3s ease;
}

.results.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.results-header {
    text-align: center;
    margin-bottom: 2rem;
}

.results-header h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.results-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.section {
    background: var(--card-bg);
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.section h2 {
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

/* ==================== ATTRACTION CARDS ==================== */

.attraction-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    border-left: 5px solid var(--primary);
}

.attraction-card:hover {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.attraction-title {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.attraction-title h3 {
    font-size: 1.3rem;
    margin: 0;
    flex: 1;
    font-weight: 600;
}

.attraction-category {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
    display: inline-block;
}

.attraction-description {
    color: #666;
    margin: 0.5rem 0 1.5rem 0;
    line-height: 1.5;
    font-size: 0.95rem;
}

[data-color-scheme="dark"] .attraction-description {
    color: #aaa;
}

.attraction-info {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    min-width: 120px;
    color: var(--text);
}

.info-value {
    flex: 1;
    text-align: right;
    color: #666;
    font-size: 0.95rem;
}

[data-color-scheme="dark"] .info-value {
    color: #aaa;
}

.info-link {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
}

.info-link:hover {
    text-decoration: underline;
}

.attraction-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.gallery-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.gallery-image:hover {
    transform: scale(1.05);
    border: 2px solid var(--primary);
}

.attraction-reviews {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--success);
}

.attraction-reviews h4 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--text);
}

.review-item {
    background: var(--card-bg);
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border-radius: 6px;
    border-left: 3px solid var(--primary);
}

.review-item strong {
    display: block;
    margin-bottom: 0.25rem;
}

.review-rating {
    color: var(--primary);
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.review-item p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
    line-height: 1.4;
}

.review-time {
    font-size: 0.8rem;
    opacity: 0.6;
}

.restaurant-card {
    border-left-color: var(--secondary);
}

.loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.loading.active {
    display: flex;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading p {
    color: white;
    font-size: 1.1rem;
}

.modal-auth {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-auth.active {
    display: flex !important;
}

.modal-content-auth {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.close-auth {
    float: right;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text);
    opacity: 0.7;
}

.close-auth:hover {
    opacity: 1;
}

.auth-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border);
}

.auth-tab {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: #999;
    transition: all 0.3s;
}

.auth-tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
}

.auth-form {
    display: none;
}

.auth-form.active {
    display: block;
}

.auth-input {
    width: 100%;
    padding: 0.75rem;
    margin: 0.75rem 0;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 1rem;
    background: var(--bg);
    color: var(--text);
}

.auth-submit {
    width: 100%;
    padding: 0.75rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 0.5rem;
}

.auth-submit:hover {
    opacity: 0.9;
}

.profile-screen {
    display: none;
}

.profile-screen.active {
    display: block;
}

.profile-container {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.profile-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.profile-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border);
    flex-wrap: wrap;
}

.profile-tab {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: #999;
}

.profile-tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
}

.profile-content {
    display: none;
}

.profile-content.active {
    display: block;
}

.profile-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.stat-card {
    background: var(--bg);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.7;
}

.route-item {
    background: var(--bg);
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
}

.route-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.route-actions button {
    padding: 0.5rem 1rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.favorites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.favorite-item {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.admin-screen {
    display: none;
}

.admin-screen.active {
    display: block;
}

.admin-container {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.admin-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border);
    flex-wrap: wrap;
}

.admin-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: #999;
}

.admin-tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
}

.admin-content {
    display: none;
}

.admin-content.active {
    display: block;
}

.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.admin-stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.admin-table thead {
    background: var(--bg);
}

.admin-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
}

.admin-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
}

.admin-table tbody tr:hover {
    background: var(--bg);
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
    }

    .welcome h1 {
        font-size: 1.8rem;
    }

    .checkbox-group {
        grid-template-columns: 1fr;
    }

    .form-buttons {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }

    .profile-stats {
        grid-template-columns: 1fr;
    }

    .attraction-gallery {
        grid-template-columns: repeat(2, 1fr);
    }

    .info-row {
        flex-direction: column;
        align-items: flex-start;
    }
}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="header-logo">
                <span>‚úàÔ∏è</span>
                <span>AI Travel Guide</span>
            </div>
            <span class="connection-status" id="connectionStatus">üî¥ Login</span>
        </div>
        <div class="header-right">
            <button class="admin-btn" id="adminBtn" onclick="showAdmin()" style="display: none;">üëë Admin</button>
            <button class="profile-btn" id="profileBtn" onclick="showProfile()" style="display: none;">üë§ Profile</button>
            <button class="profile-btn" id="loginBtn" onclick="showLoginModal()">üîê Login</button>
            <button class="logout-btn" id="logoutBtn" onclick="handleLogout()">üö™ Logout</button>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">üåô Light Mode</button>
        </div>
    </header>

    <div class="container">
        <div class="welcome" id="welcomeScreen">
            <h1>Discover Your Next Adventure</h1>
            <p>Build personalized itineraries with AI-powered recommendations</p>
            <button class="cta-button" onclick="startPlanning()">‚ú® Start Planning</button>
        </div>

        <div class="form-container" id="formContainer">
            <div class="progress-bar">
                <div id="progressFill"></div>
            </div>

            <div id="step1" class="form-step active">
                <h2>Where do you want to go?</h2>
                <div class="form-group">
                    <label>Destination City *</label>
                    <input type="text" id="destination" placeholder="e.g., Paris, Tokyo, New York...">
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="cancelPlanning()">‚Üê Start Over</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next ‚Üí</button>
                </div>
            </div>

            <div id="step2" class="form-step">
                <h2>When are you traveling?</h2>
                <div class="form-group">
                    <label>Check-in (Optional)</label>
                    <input type="date" id="checkIn">
                </div>
                <div class="form-group">
                    <label>Check-out (Optional)</label>
                    <input type="date" id="checkOut">
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="prevStep(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">Next ‚Üí</button>
                </div>
            </div>

            <div id="step3" class="form-step">
                <h2>What interests you?</h2>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="history"> üìö History
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="nature"> üåø Nature
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="food"> üçΩÔ∏è Food
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="shopping"> üõçÔ∏è Shopping
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="nightlife"> üåÉ Nightlife
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="interests" value="adventure"> üèîÔ∏è Adventure
                    </label>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="prevStep(2)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextStep(4)">Next ‚Üí</button>
                </div>
            </div>

            <div id="step4" class="form-step">
                <h2>Travel Style</h2>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="radio" name="travelStyle" value="budget"> üí∞ Budget
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="travelStyle" value="mid-range"> üíµ Mid-range
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="travelStyle" value="luxury"> üíé Luxury
                    </label>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="prevStep(3)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextStep(5)">Next ‚Üí</button>
                </div>
            </div>

            <div id="step5" class="form-step">
                <h2>Group Type</h2>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="radio" name="groupType" value="solo"> Solo Traveler
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="groupType" value="couple"> Couple
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="groupType" value="family"> Family
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="groupType" value="group"> Group
                    </label>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="prevStep(4)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="generateItinerary()">üöÄ Generate Itinerary</button>
                </div>
            </div>
        </div>

        <div class="results" id="resultsScreen">
            <div class="results-header">
                <button class="btn" onclick="cancelPlanning()" style="margin-bottom: 1rem;">‚Üê Start Over</button>
                <h2 id="resultsTitle">Your Adventure</h2>
                <p id="resultsSubtitle"></p>
                <div class="results-actions">
                    <button class="btn btn-primary" onclick="saveCurrentRoute()">üíæ Save Route</button>
                </div>
            </div>

            <div id="itineraryView" class="section"></div>
            <div id="restaurantsView" class="section"></div>
            <div id="tipsView" class="section"></div>
        </div>

        <div class="profile-screen" id="profileScreen">
            <div class="profile-container">
                <button class="btn" onclick="closeProfile()">‚Üê Back</button>
                <div class="profile-header">
                    <h2>üë§ My Profile</h2>
                    <p id="profileUsername">Loading...</p>
                </div>

                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchProfileTab('info')">üìã Info</button>
                    <button class="profile-tab" onclick="switchProfileTab('routes')">üó∫Ô∏è Routes</button>
                    <button class="profile-tab" onclick="switchProfileTab('favorites')">‚ù§Ô∏è Favorites</button>
                </div>

                <div id="infoTab" class="profile-content active">
                    <h3>Account Information</h3>
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRoutes">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalFavorites">0</div>
                            <div class="stat-label">Favorites</div>
                        </div>
                    </div>
                    <p>Email: <strong id="profileEmail">-</strong></p>
                </div>

                <div id="routesTab" class="profile-content">
                    <div id="savedRoutesContainer"><p>No routes yet.</p></div>
                </div>

                <div id="favoritesTab" class="profile-content">
                    <div id="favoritesContainer"><p>No favorites yet.</p></div>
                </div>
            </div>
        </div>

        <div class="admin-screen" id="adminScreen">
            <div class="admin-container">
                <button class="btn" onclick="closeAdmin()">‚Üê Back</button>
                <h2>üëë Admin Dashboard</h2>

                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('overview')">Overview</button>
                    <button class="admin-tab" onclick="switchAdminTab('users')">Users</button>
                    <button class="admin-tab" onclick="switchAdminTab('activity')">Activity</button>
                </div>

                <div id="overviewTab" class="admin-content active">
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <h3 id="totalUsers">0</h3>
                            <p>Users</p>
                        </div>
                        <div class="admin-stat-card">
                            <h3 id="totalRoutesAdmin">0</h3>
                            <p>Routes</p>
                        </div>
                        <div class="admin-stat-card">
                            <h3 id="totalFavoritesAdmin">0</h3>
                            <p>Favorites</p>
                        </div>
                    </div>
                </div>

                <div id="usersTab" class="admin-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="5">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="activityTab" class="admin-content">
                    <div id="activityContainer"><p>No activity yet.</p></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-auth" id="authModal">
        <div class="modal-content-auth">
            <span class="close-auth" onclick="closeAuthModal()">√ó</span>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="loginForm" class="auth-form active">
                <h3>Sign In</h3>
                <input type="text" id="authUsername" class="auth-input" placeholder="Username">
                <input type="password" id="authPassword" class="auth-input" placeholder="Password">
                <button class="auth-submit" onclick="handleLogin()">Login</button>
            </div>

            <div id="registerForm" class="auth-form">
                <h3>Register</h3>
                <input type="text" id="regUsername" class="auth-input" placeholder="Username">
                <input type="email" id="regEmail" class="auth-input" placeholder="Email">
                <input type="password" id="regPassword" class="auth-input" placeholder="Password">
                <button class="auth-submit" onclick="handleRegister()">Register</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loadingModal">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>

    <script>
        // ==================== AUTH & CACHE MANAGER ====================
        const API_BASE_URL = 'http://localhost:5000';

        const AuthManager = {
            token: null,
            user: null,

            init() {
                this.token = localStorage.getItem('auth_token');
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    try {
                        this.user = JSON.parse(userData);
                    } catch (e) {
                        this.logout();
                    }
                }
            },

            isLoggedIn() { return !!this.token; },

            async register(username, email, password) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username, email, password})
                    });
                    const data = await response.json();
                    if (response.ok) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('user_data', JSON.stringify(data.user));
                        return {success: true};
                    }
                    return {success: false, error: data.error};
                } catch (error) {
                    return {success: false, error: error.message};
                }
            },

            async login(username, password) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username, password})
                    });
                    const data = await response.json();
                    if (response.ok) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('user_data', JSON.stringify(data.user));
                        return {success: true};
                    }
                    return {success: false, error: data.error};
                } catch (error) {
                    return {success: false, error: error.message};
                }
            },

            logout() {
                this.token = null;
                this.user = null;
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_data');
            },

            getAuthHeader() {
                return {'Authorization': `Bearer ${this.token}`};
            }
        };

        const RouteCache = {
            get(city, interests) {
                const key = this.generateKey(city, interests);
                const cached = localStorage.getItem(key);
                if (cached) {
                    try {
                        const data = JSON.parse(cached);
                        const age = Date.now() - data.timestamp;
                        if (age < 24 * 60 * 60 * 1000) {
                            console.log('üì¶ Cache hit');
                            return data.route;
                        }
                    } catch (e) {}
                }
                return null;
            },

            set(city, interests, routeData) {
                const key = this.generateKey(city, interests);
                try {
                    localStorage.setItem(key, JSON.stringify({route: routeData, timestamp: Date.now()}));
                } catch (e) {}
            },

            generateKey(city, interests) {
                const sorted = [...interests].sort().join('_');
                return `route_${city.toLowerCase()}_${sorted}`;
            }
        };

        // ==================== UI HELPER FUNCTIONS ====================

        function showLoginModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginForm').classList.add('active');
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
            } else {
                document.getElementById('registerForm').classList.add('active');
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
            }
        }

        // ==================== AUTH FUNCTIONS ====================

        async function handleLogin() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            if (!username || !password) { 
                alert('Please fill all fields'); 
                return; 
            }
            const result = await AuthManager.login(username, password);
            if (result.success) {
                alert('‚úÖ Welcome back!');
                document.getElementById('authModal').classList.remove('active');
                updateAuthUI();
            } else {
                alert('‚ùå ' + result.error);
            }
        }

        async function handleRegister() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            if (!username || !email || !password) { 
                alert('Please fill all fields'); 
                return; 
            }
            const result = await AuthManager.register(username, email, password);
            if (result.success) {
                alert('‚úÖ Account created!');
                document.getElementById('authModal').classList.remove('active');
                updateAuthUI();
            } else {
                alert('‚ùå ' + result.error);
            }
        }

        // ==================== PROFILE FUNCTIONS ====================

        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const profileBtn = document.getElementById('profileBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (AuthManager.isLoggedIn()) {
                loginBtn.style.display = 'none';
                profileBtn.style.display = 'block';
                logoutBtn.style.display = 'block';
                profileBtn.innerHTML = `üë§ ${AuthManager.user.username}`;
                
                if (adminBtn && AuthManager.user.is_admin) {
                    adminBtn.style.display = 'block';
                } else if (adminBtn) {
                    adminBtn.style.display = 'none';
                }
                
                document.getElementById('connectionStatus').innerHTML = '‚úÖ Connected';
            } else {
                loginBtn.style.display = 'block';
                profileBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
                if (adminBtn) adminBtn.style.display = 'none';
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Login';
            }
        }

        function showProfile() {
            if (!AuthManager.isLoggedIn()) {
                showLoginModal();
                return;
            }
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('formContainer').classList.remove('active');
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('profileScreen').classList.add('active');
            
            loadProfileInfo();
            switchProfileTab('info');
        }

        function closeProfile() {
            document.getElementById('profileScreen').classList.remove('active');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function switchProfileTab(tab) {
            document.querySelectorAll('.profile-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'info') {
                document.getElementById('infoTab').classList.add('active');
                document.querySelectorAll('.profile-tab')[0].classList.add('active');
            } else if (tab === 'routes') {
                document.getElementById('routesTab').classList.add('active');
                loadSavedRoutes();
                document.querySelectorAll('.profile-tab')[1].classList.add('active');
            } else if (tab === 'favorites') {
                document.getElementById('favoritesTab').classList.add('active');
                loadFavorites();
                document.querySelectorAll('.profile-tab')[2].classList.add('active');
            }
        }

        async function loadProfileInfo() {
            if (!AuthManager.isLoggedIn()) return;
            
            document.getElementById('profileUsername').textContent = `Welcome, ${AuthManager.user.username}!`;
            document.getElementById('profileEmail').textContent = AuthManager.user.email || '-';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/profile`, {
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;
                    document.getElementById('totalRoutes').textContent = user.routes_count || 0;
                    document.getElementById('totalFavorites').textContent = user.favorites_count || 0;
                    
                    const joinDate = new Date(user.created_at);
                    document.getElementById('memberSince').textContent = joinDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadSavedRoutes() {
            if (!AuthManager.isLoggedIn()) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/routes`, {
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const routes = data.routes || [];
                    const container = document.getElementById('savedRoutesContainer');
                    
                    if (routes.length === 0) {
                        container.innerHTML = '<p>No saved routes yet.</p>';
                        return;
                    }
                    
                    let html = '';
                    routes.forEach(route => {
                        const date = new Date(route.created_at).toLocaleDateString();
                        html += `
                            <div class="route-item">
                                <h4>üìç ${route.route_name}</h4>
                                <div class="route-info">
                                    <span>üåç ${route.city}</span>
                                    <span>üìÖ ${date}</span>
                                </div>
                                <div class="route-actions">
                                    <button onclick="openRoute(${route.id})">üìÇ Open</button>
                                    <button onclick="deleteRoute(${route.id})" style="background: #ef4444;">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading routes:', error);
            }
        }

        async function loadFavorites() {
            if (!AuthManager.isLoggedIn()) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites`, {
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const favorites = data.favorites || [];
                    const container = document.getElementById('favoritesContainer');
                    
                    if (favorites.length === 0) {
                        container.innerHTML = '<p>No favorites yet.</p>';
                        return;
                    }
                    
                    let html = '';
                    favorites.forEach(fav => {
                        html += `
                            <div class="favorite-item">
                                <h4>${fav.place_name}</h4>
                                <p style="font-size: 0.9rem; opacity: 0.7;">${fav.city || 'Unknown'}</p>
                                <button class="remove-btn" onclick="removeFavorite(${fav.id})">Remove ‚ùå</button>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        async function removeFavorite(favId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites/${favId}`, {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    loadFavorites();
                }
            } catch (error) {
                alert('Error removing favorite');
            }
        }

        async function deleteRoute(routeId) {
            if (!confirm('Delete this route?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/routes/${routeId}`, {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    alert('‚úÖ Route deleted');
                    loadSavedRoutes();
                }
            } catch (error) {
                alert('Error deleting route');
            }
        }

        async function openRoute(routeId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/routes`, {
                    headers: AuthManager.getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const route = data.routes.find(r => r.id === routeId);
                    
                    if (route) {
                        currentRouteData = route.route_data;
                        document.getElementById('profileScreen').classList.remove('active');
                        document.getElementById('resultsScreen').classList.add('active');
                        renderResultsFromBackend(route.route_data);
                    }
                }
            } catch (error) {
                alert('Error loading route');
            }
        }

        async function saveCurrentRoute() {
            if (!AuthManager.isLoggedIn()) {
                alert('Please login to save routes');
                showLoginModal();
                return;
            }
            const routeName = prompt('Enter route name:');
            if (!routeName) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/routes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...AuthManager.getAuthHeader()
                    },
                    body: JSON.stringify({
                        route_name: routeName,
                        city: formData.destination,
                        route_data: currentRouteData || {}
                    })
                });
                if (response.ok) {
                    alert('‚úÖ Route saved!');
                } else {
                    alert('‚ùå Error saving route');
                }
            } catch (error) {
                alert('‚ùå Network error');
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                AuthManager.logout();
                document.getElementById('profileScreen').classList.remove('active');
                document.getElementById('adminScreen').classList.remove('active');
                document.getElementById('formContainer').classList.remove('active');
                document.getElementById('resultsScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                updateAuthUI();
            }
        }

        // ==================== ADMIN FUNCTIONS ====================

        function showAdmin() {
            if (!AuthManager.isLoggedIn()) {
                showLoginModal();
                return;
            }

            if (!AuthManager.user.is_admin) {
                alert('‚ùå Admin access required');
                return;
            }

            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('formContainer').classList.remove('active');
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('profileScreen').classList.remove('active');
            document.getElementById('adminScreen').classList.add('active');

            loadAdminOverview();
        }

        function closeAdmin() {
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));

            if (tab === 'overview') {
                document.getElementById('overviewTab').classList.add('active');
                loadAdminOverview();
            } else if (tab === 'users') {
                document.getElementById('usersTab').classList.add('active');
                loadUsers();
            } else if (tab === 'activity') {
                document.getElementById('activityTab').classList.add('active');
                loadActivity();
            }

            document.querySelectorAll('.admin-tab')[
                ['overview', 'users', 'activity'].indexOf(tab)
            ].classList.add('active');
        }

        async function loadAdminOverview() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/stats`, {
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalUsers').textContent = data.total_users || 0;
                    document.getElementById('totalRoutesAdmin').textContent = data.total_routes || 0;
                    document.getElementById('totalFavoritesAdmin').textContent = data.total_favorites || 0;
                    document.getElementById('adminCount').textContent = data.admin_count || 0;
                }
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    const data = await response.json();
                    let html = '';

                    data.users.forEach(user => {
                        const joinDate = new Date(user.created_at).toLocaleDateString();
                        const adminBadge = user.is_admin ? 
                            '<span class="badge badge-admin">Admin</span>' : 
                            '<span class="badge badge-user">User</span>';

                        html += `
                            <tr>
                                <td>${user.id}</td>
                                <td><strong>${user.username}</strong></td>
                                <td>${user.email}</td>
                                <td>${joinDate}</td>
                                <td>${user.route_count}</td>
                                <td>${adminBadge}</td>
                                <td>
                                    ${user.is_admin ? 
                                        `<button class="action-btn demote-btn" onclick="demoteUser(${user.id})">Demote</button>` :
                                        `<button class="action-btn promote-btn" onclick="promoteUser(${user.id})">Promote</button>`
                                    }
                                    <button class="action-btn delete-btn" onclick="deleteUser(${user.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });

                    document.getElementById('usersTableBody').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Error loading users</td></tr>';
            }
        }

        async function promoteUser(userId) {
            if (!confirm('Promote this user to admin?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}/promote`, {
                    method: 'POST',
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    alert('‚úÖ User promoted to admin');
                    loadUsers();
                } else {
                    alert('‚ùå Error promoting user');
                }
            } catch (error) {
                alert('‚ùå Error promoting user');
            }
        }

        async function demoteUser(userId) {
            if (!confirm('Demote this user from admin?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}/demote`, {
                    method: 'POST',
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    alert('‚úÖ User demoted');
                    loadUsers();
                } else {
                    alert('‚ùå Error demoting user');
                }
            } catch (error) {
                alert('‚ùå Error demoting user');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Delete this user? This action cannot be undone!')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    alert('‚úÖ User deleted');
                    loadUsers();
                } else {
                    alert('‚ùå Error deleting user');
                }
            } catch (error) {
                alert('‚ùå Error deleting user');
            }
        }

        async function loadActivity() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/activity`, {
                    headers: AuthManager.getAuthHeader()
                });

                if (response.ok) {
                    const data = await response.json();
                    let html = '';

                    if (data.activity.length === 0) {
                        html = '<p style="text-align: center; opacity: 0.7;">No activity yet</p>';
                    } else {
                        data.activity.forEach(activity => {
                            const date = new Date(activity.created_at).toLocaleString();
                            let icon = 'üìù';

                            if (activity.action === 'route_created') icon = 'üó∫Ô∏è';
                            if (activity.action === 'favorite_added') icon = '‚ù§Ô∏è';
                            if (activity.action === 'user_registered') icon = 'üë§';

                            html += `
                                <div class="activity-item">
                                    <h4>${icon} ${activity.username}</h4>
                                    <p>${activity.description}</p>
                                    <div class="activity-time">üìÖ ${date}</div>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('activityContainer').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityContainer').innerHTML = 
                    '<p style="text-align: center; color: #ef4444;">Error loading activity</p>';
            }
        }

        // ==================== TRAVEL PLANNING ====================

        const API_ENDPOINTS = {
            generateItinerary: '/api/generate-itinerary',
            health: '/api/health'
        };

        let currentStep = 1;
        let currentTheme = 'light';
        let currentRouteData = null;
        let formData = {
            destination: '',
            checkIn: '',
            checkOut: '',
            interests: [],
            travelStyle: '',
            groupType: '',
            accessibility: []
        };

        function initTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            currentTheme = prefersDark ? 'dark' : 'light';
            document.documentElement.setAttribute('data-color-scheme', currentTheme);
            updateThemeButton();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-color-scheme', currentTheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const button = document.getElementById('themeToggle');
            button.textContent = currentTheme === 'light' ? 'üåô Light Mode' : '‚òÄÔ∏è Dark Mode';
        }

        function startPlanning() {
            if (!AuthManager.isLoggedIn()) {
                showLoginModal();
                return;
            }
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('formContainer').classList.add('active');
        }

        function cancelPlanning() {
            document.getElementById('formContainer').classList.remove('active');
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('profileScreen').classList.remove('active');
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            resetForm();
        }

        function nextStep(step) {
            if (currentStep === 1) {
                const destination = document.getElementById('destination').value.trim();
                if (!destination) {
                    alert('Please enter a city name');
                    return;
                }
                formData.destination = destination;
            }
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }

        function prevStep(step) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }

        function updateProgress() {
            const progress = (currentStep / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function resetForm() {
            currentStep = 1;
            formData = {destination: '', checkIn: '', checkOut: '', interests: [], travelStyle: '', groupType: '', accessibility: []};
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            updateProgress();
        }

        async function generateItinerary() {
            formData.checkIn = document.getElementById('checkIn').value;
            formData.checkOut = document.getElementById('checkOut').value;
            formData.interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(cb => cb.value);
            const travelStyleInput = document.querySelector('input[name="travelStyle"]:checked');
            formData.travelStyle = travelStyleInput ? travelStyleInput.value : 'cultural';
            const groupTypeInput = document.querySelector('input[name="groupType"]:checked');
            formData.groupType = groupTypeInput ? groupTypeInput.value : 'solo';

            const cached = RouteCache.get(formData.destination, formData.interests);
            if (cached && AuthManager.isLoggedIn()) {
                console.log('üì¶ Using cached route');
                currentRouteData = cached;
                renderResultsFromBackend(cached);
                document.getElementById('formContainer').classList.remove('active');
                document.getElementById('resultsScreen').classList.add('active');
                return;
            }

            showLoading('Fetching real data from Google Places API...');
            try {
                const requestData = {
                    city: formData.destination,
                    start_date: formData.checkIn || null,
                    end_date: formData.checkOut || null,
                    interests: formData.interests,
                    travel_style: formData.travelStyle,
                    group_type: formData.groupType,
                    accessibility_needs: []
                };

                const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.generateItinerary}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                hideLoading();
                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const data = await response.json();
                currentRouteData = data;
                RouteCache.set(formData.destination, formData.interests, data);

                renderResultsFromBackend(data);
                document.getElementById('formContainer').classList.remove('active');
                document.getElementById('resultsScreen').classList.add('active');

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showError('Cannot connect to server. Make sure Flask is running on http://localhost:5000');
            }
        }

        function renderResultsFromBackend(data) {
            const destination = data.city || formData.destination;
            const tripDays = data.duration_days || (data.itinerary ? data.itinerary.length : 0);
            document.getElementById('resultsTitle').textContent = `Your ${destination} Adventure`;
            const dateRange = formData.checkIn && formData.checkOut ? `${formatDate(formData.checkIn)} - ${formatDate(formData.checkOut)}` : `${tripDays} day trip`;
            document.getElementById('resultsSubtitle').textContent = dateRange;
            renderItineraryFromBackend(data.itinerary || []);
            renderRestaurantsFromBackend(data.itinerary || []);
            renderTipsFromBackend(data.tips || []);
        }

        function renderItineraryFromBackend(itinerary) {
            const container = document.getElementById('itineraryView');
            if (!itinerary || !itinerary.length) {
                container.innerHTML = '<p>No itinerary data available.</p>';
                return;
            }

            let html = '';
            
            itinerary.forEach(day => {
                if (day.activities && day.activities.length > 0) {
                    day.activities.forEach(activity => {
                        const openHours = activity.opening_hours && activity.opening_hours.length > 0 ? activity.opening_hours[0] : 'Hours not available';
                        const hasPhotos = activity.photos && activity.photos.length > 0;
                        
                        html += `
                            <div class="attraction-card">
                                <div class="attraction-title">
                                    <h3>${activity.name}</h3>
                                    <div class="attraction-category">${activity.category || 'Sightseeing'}</div>
                                </div>
                                
                                <p class="attraction-description">${activity.description || 'Popular attraction'}</p>
                                
                                <div class="attraction-info">
                                    <div class="info-row">
                                        <span class="info-label">üìç Location</span>
                                        <span class="info-value">${activity.address || activity.location || 'Address not available'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">‚≠ê Rating</span>
                                        <span class="info-value">${activity.rating || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">üìû Phone</span>
                                        <span class="info-value">${activity.phone || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">üåê Website</span>
                                        ${activity.website && activity.website !== 'N/A' ? 
                                            `<a href="${activity.website}" target="_blank" class="info-link">Website</a>` : 
                                            '<span class="info-value">N/A</span>'
                                        }
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">üïê Hours</span>
                                        <span class="info-value">${openHours}</span>
                                    </div>
                                </div>

                                ${hasPhotos ? `
                                    <div class="attraction-gallery">
                                        ${activity.photos.slice(0, 3).map(photo => 
                                            `<img src="${photo}" alt="${activity.name}" class="gallery-image" style="cursor: pointer;">`
                                        ).join('')}
                                    </div>
                                ` : ''}

                                ${activity.reviews && activity.reviews.length > 0 ? `
                                    <div class="attraction-reviews">
                                        <h4>Reviews:</h4>
                                        ${activity.reviews.slice(0, 2).map(review => `
                                            <div class="review-item">
                                                <strong>${review.author}</strong>
                                                <div class="review-rating">‚≠ê ${review.rating}</div>
                                                <p>${review.text}</p>
                                                <div class="review-time">${review.time}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = html || '<p>No activities found.</p>';
        }

        function renderRestaurantsFromBackend(itinerary) {
            const container = document.getElementById('restaurantsView');
            const restaurants = [];
            itinerary.forEach(day => {
                day.restaurants?.forEach(restaurant => {
                    restaurants.push(restaurant);
                });
            });

            if (restaurants.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<h2>üçΩÔ∏è Restaurants</h2>';
            restaurants.forEach(restaurant => {
                const hasPhotos = restaurant.photos && restaurant.photos.length > 0;
                
                html += `
                    <div class="attraction-card restaurant-card">
                        <div class="attraction-title">
                            <h3>${restaurant.name}</h3>
                            <div class="attraction-category">Restaurant</div>
                        </div>
                        
                        <div class="attraction-info">
                            <div class="info-row">
                                <span class="info-label">üíµ Price</span>
                                <span class="info-value">${restaurant.price || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">‚≠ê Rating</span>
                                <span class="info-value">${restaurant.rating || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìç Address</span>
                                <span class="info-value">${restaurant.address || 'Address not available'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìû Phone</span>
                                <span class="info-value">${restaurant.phone || 'N/A'}</span>
                            </div>
                        </div>

                        ${hasPhotos ? `
                            <div class="attraction-gallery">
                                ${restaurant.photos.slice(0, 2).map(photo => 
                                    `<img src="${photo}" alt="${restaurant.name}" class="gallery-image" style="cursor: pointer;">`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderTipsFromBackend(tips) {
            const container = document.getElementById('tipsView');
            if (!tips || tips.length === 0) {
                container.innerHTML = '';
                return;
            }
            let html = '<h2>üí° Tips</h2><div style="display: grid; gap: 1rem;">';
            tips.forEach(tip => { 
                html += `<div style="background: var(--bg); padding: 1rem; border-left: 4px solid var(--primary); border-radius: 4px;">${tip}</div>`; 
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
        }

        function showLoading(message) {
            const loader = document.getElementById('loadingModal');
            if (loader) {
                loader.querySelector('p').textContent = message;
                loader.classList.add('active');
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loadingModal');
            if (loader) loader.classList.remove('active');
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        // ==================== INITIALIZE ====================

        document.addEventListener('DOMContentLoaded', function() {
            AuthManager.init();
            updateAuthUI();
            initTheme();
        });

    </script>
</body>
</html>
